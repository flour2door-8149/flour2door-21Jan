generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["driverAdapters"]
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum RefundStatus {
  NOT_INITIATED
  REFUND_INITIATED
  REFUNDED
  REFUND_FAILED
}

// Required for creating a User: id, name, email, image, cart (optional JSON string)
model User {
  id              String    @id
  email           String    @unique
  name            String?
  image           String?
  cart            Json      @default("{}")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  store           Store?
  addresses       Address[]
  orders          Order[]
  ratings         Rating[]
  deliveryOrders  Order[]   @relation("DeliveryBoyOrders")

  @@index([email])
}


// Required for creating a Product: name, description, mrp, price, images, category, storeId
model Product {
model Product {
  id                  String   @id @default(cuid())
  storeId             String
  name                String
  description         String
  mrp                 Float
  price               Float
  category            String
  images              String[]
  inStock             Boolean  @default(true)
  stock               Int      @default(0)
  lowStockThreshold   Int      @default(10)
  lastRestocked       DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  store               Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  rating              Rating[]
  orderItems          OrderItem[]

  @@index([storeId])
  @@index([inStock])
}
enum OrderStatus {
  ORDER_PLACED
  ACCEPTED
  PROCESSING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  REJECTED
  CANCELLED
}
enum PaymentMethod {
    COD
    STRIPE
}

// Required for creating an Order: total, userId, storeId, addressId, isPaid, paymentMethod, isCouponUsed, coupon (JSON), orderItems (nested)
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique @default(cuid())
  userId          String
  storeId         String
  addressId       String
  total           Float
  paymentMethod   PaymentMethod
  isPaid          Boolean     @default(false)
  status          OrderStatus @default(ORDER_PLACED)
  rejectionReason String?
  refundStatus    RefundStatus @default(NOT_INITIATED)
  refundId        String?
  invoiceUrl      String?
  packingSlipUrl  String?
  deliveryBoyId   String?
  isCouponUsed    Boolean     @default(false)
  coupon          Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  store           Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  address         Address     @relation(fields: [addressId], references: [id])
  deliveryBoy     User?       @relation("DeliveryBoyOrders", fields: [deliveryBoyId], references: [id])
  orderItems      OrderItem[]

  ratings         Rating[]
  @@index([userId])
  @@index([storeId])
  @@index([status])
}

// Required for creating an OrderItem: orderId, productId, quantity, price
model OrderItem {
    orderId   String
    productId String
    quantity  Int
    price     Float

    // Relations
    order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id])

    @@id([orderId, productId])
}

// Required for creating a Rating: rating, review, userId, productId
model Rating {
  id              String   @id @default(cuid())
  userId          String
  productId       String
  orderId         String
  rating          Int
  review          String
  storeResponse   String?
  respondedAt     DateTime?
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, productId])
  @@index([userId])
  @@index([productId])
}
// Required for creating an Address: userId, name, email, street, city, state, zip, country, phone
model Address {
    id        String   @id @default(cuid())
    userId    String
    name      String
    email     String
    street    String
    city      String
    state     String
    zip       String
    country   String
    phone     String
    createdAt DateTime @default(now())

    // Relations
    Order Order[]
    user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Required for creating a Coupon: code, description, discount, forNewUser, isPublic, expiresAt
model Coupon {
    code        String   @id
    description String
    discount    Float
    forNewUser  Boolean
    forMember   Boolean  @default(false)
    isPublic    Boolean
    expiresAt   DateTime
    createdAt   DateTime @default(now())
}

// Required for creating a Store: userId, name, username, email, contact, logo, description, address (optional: , status, isActive)
model Store {
  id              String    @id @default(cuid())
  userId          String    @unique
  name            String
  username        String    @unique
  description     String
  email           String
  contact         String
  address         String
  logo            String
  status          StoreStatus @default(pending)
  isActive        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Product         Product[]
  Order           Order[]
  InventoryHistory InventoryHistory[]

  @@index([userId])
  @@index([username])
  @@index([status])
}
model InventoryHistory {
  id          String   @id @default(cuid())
  productId   String
  storeId     String
  quantity    Int
  type        String   // 'restock', 'sale', 'adjustment', 'return'
  reason      String?
  createdAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([storeId])
}