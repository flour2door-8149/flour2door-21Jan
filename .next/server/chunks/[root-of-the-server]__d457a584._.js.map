{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 103, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Flour2door/lib/prisma.js"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\nimport { PrismaNeon } from '@prisma/adapter-neon';\r\nimport { neonConfig } from '@neondatabase/serverless';\r\n\r\nimport ws from 'ws';\r\nneonConfig.webSocketConstructor = ws; \r\n\r\n// To work in edge environments (Cloudflare Workers, Vercel Edge, etc.), enable querying over fetch\r\nneonConfig.poolQueryViaFetch = true\r\n\r\n// Type definitions\r\n// declare global {\r\n//   var prisma: PrismaClient | undefined\r\n// }\r\n\r\nconst connectionString = `${process.env.DATABASE_URL}`;\r\n\r\nconst adapter = new PrismaNeon({ connectionString });\r\nconst prisma = global.prisma || new PrismaClient(process.env.NEXT_RUNTIME === \"edge\" ? { adapter } : {});\r\n\r\nif (process.env.NEXT_RUNTIME !== 'edge') global.prisma = prisma;\r\n\r\nexport default prisma; "],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAEA;;;;;AACA,sKAAU,CAAC,oBAAoB,GAAG,2JAAE;AAEpC,mGAAmG;AACnG,sKAAU,CAAC,iBAAiB,GAAG;AAE/B,mBAAmB;AACnB,mBAAmB;AACnB,yCAAyC;AACzC,IAAI;AAEJ,MAAM,mBAAmB,GAAG,QAAQ,GAAG,CAAC,YAAY,EAAE;AAEtD,MAAM,UAAU,IAAI,6KAAU,CAAC;IAAE;AAAiB;AAClD,MAAM,SAAS,yDAAO,MAAM,IAAI,IAAI,6IAAY,CAAC,sCAAsC,0BAAc,CAAC;AAEtG,wCAAyC,yDAAO,MAAM,GAAG;uCAE1C","debugId":null}},
    {"offset": {"line": 163, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Flour2door/app/api/orders/route.js"],"sourcesContent":["import prisma from \"@/lib/prisma\";\r\nimport { getAuth } from \"@clerk/nextjs/server\";\r\nimport { PaymentMethod } from \"@prisma/client\";\r\nimport { NextResponse } from \"next/server\";\r\nimport Stripe from \"stripe\";\r\n\r\n\r\nexport async function POST(request){\r\n    try {\r\n        const { userId, has } = getAuth(request)\r\n        if(!userId){\r\n            return NextResponse.json({ error: \"not authorized\" }, { status: 401 });\r\n        }\r\n        const { addressId, items, couponCode, paymentMethod } = await request.json()\r\n\r\n        // Check if all required fields are present\r\n        if(!addressId || !paymentMethod || !items || !Array.isArray(items) || items.length === 0){\r\n           return NextResponse.json({ error: \"missing order details.\" }, { status: 401 }); \r\n        }\r\n\r\n        let coupon = null;\r\n\r\n        if (couponCode) {\r\n        coupon = await prisma.coupon.findUnique({\r\n                    where: {code: couponCode }\r\n                })\r\n                if (!coupon){\r\n            return NextResponse.json({ error: \"Coupon not found\" }, { status: 400 })\r\n        }\r\n        }\r\n         \r\n            // Check if coupon is applicable for new users\r\n        if(couponCode && coupon.forNewUser){\r\n            const userorders = await prisma.order.findMany({where: {userId}})\r\n            if(userorders.length > 0){\r\n                return NextResponse.json({ error: \"Coupon valid for new users\" }, { status: 400 })\r\n            }\r\n        }\r\n\r\n        const isPlusMember = has({plan: 'plus'})\r\n\r\n        // Check if coupon is applicable for members\r\n        if (couponCode && coupon.forMember){\r\n            if(!isPlusMember){\r\n                return NextResponse.json({ error: \"Coupon valid for members only\" }, { status: 400 })\r\n            }\r\n        }\r\n\r\n         // Group orders by storeId using a Map\r\n         const ordersByStore = new Map()\r\n\r\n         for(const item of items){\r\n            const product = await prisma.product.findUnique({where: {id: item.id}})\r\n            const storeId = product.storeId\r\n            if(!ordersByStore.has(storeId)){\r\n                ordersByStore.set(storeId, [])\r\n            }\r\n            ordersByStore.get(storeId).push({...item, price: product.price})\r\n         }\r\n\r\n         let orderIds = [];\r\n         let fullAmount = 0;\r\n\r\n         let isShippingFeeAdded = false\r\n\r\n         // Create orders for each seller\r\n         for(const [storeId, sellerItems] of ordersByStore.entries()){\r\n            let total = sellerItems.reduce((acc, item)=>acc + (item.price * item.quantity), 0)\r\n\r\n            if(couponCode){\r\n                total -= (total * coupon.discount) / 100;\r\n            }\r\n            if(!isPlusMember && !isShippingFeeAdded){\r\n                total += 5;\r\n                isShippingFeeAdded = true\r\n            }\r\n\r\n            fullAmount += parseFloat(total.toFixed(2))\r\n\r\n            const order = await prisma.order.create({\r\n                data: {\r\n                    userId,\r\n                     storeId,\r\n                     addressId,\r\n                     total: parseFloat(total.toFixed(2)),\r\n                     paymentMethod,\r\n                     isCouponUsed: coupon ? true : false,\r\n                     coupon: coupon ? coupon : {},\r\n                      orderItems: {\r\n                        create: sellerItems.map(item => ({\r\n                            productId: item.id,\r\n                            quantity: item.quantity,\r\n                            price: item.price\r\n                        }))\r\n                      }\r\n                }\r\n            })\r\n            orderIds.push(order.id)\r\n         }\r\n\r\n         if(paymentMethod === 'STRIPE'){\r\n            const stripe = Stripe(process.env.STRIPE_SECRET_KEY)\r\n            const origin = await request.headers.get('origin')\r\n\r\n            const session = await stripe.checkout.sessions.create({\r\n                payment_method_types: ['card'],\r\n                line_items: [{\r\n                    price_data:{\r\n                        currency: 'usd',\r\n                        product_data:{\r\n                            name: 'Order'\r\n                        },\r\n                        unit_amount: Math.round(fullAmount * 100)\r\n                    },\r\n                    quantity: 1\r\n                }],\r\n                expires_at: Math.floor(Date.now() / 1000) + 30 * 60, // current time + 30 minutes\r\n                mode: 'payment',\r\n                success_url: `${origin}/loading?nextUrl=orders`,\r\n                cancel_url: `${origin}/cart`,\r\n                metadata: {\r\n                    orderIds: orderIds.join(','),\r\n                    userId,\r\n                    appId: 'flour2door'\r\n                }\r\n            })\r\n            return NextResponse.json({session})\r\n         }\r\n\r\n          // clear the cart\r\n          await prisma.user.update({\r\n            where: {id: userId},\r\n            data: {cart : {}}\r\n          })\r\n\r\n          return NextResponse.json({message: 'Orders Placed Successfully'})\r\n\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json({ error: error.code || error.message }, { status: 400 })\r\n    }\r\n}\r\n\r\n// Get all orders for a user\r\nexport async function GET(request){\r\n    try {\r\n        const { userId } = getAuth(request)\r\n        const orders = await prisma.order.findMany({\r\n            where: {userId, OR: [\r\n                {paymentMethod: PaymentMethod.COD},\r\n                {AND: [{paymentMethod: PaymentMethod.STRIPE}, {isPaid: true}]}\r\n            ]},\r\n            include: {\r\n                orderItems: {include: {product: true}},\r\n                address: true\r\n            },\r\n            orderBy: {createdAt: 'desc'}\r\n        })\r\n\r\n        return NextResponse.json({orders})\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json({ error: error.message }, { status: 400 })\r\n    }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAGO,eAAe,KAAK,OAAO;IAC9B,IAAI;QACA,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,GAAG,IAAA,wLAAO,EAAC;QAChC,IAAG,CAAC,QAAO;YACP,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QACA,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE1E,2CAA2C;QAC3C,IAAG,CAAC,aAAa,CAAC,iBAAiB,CAAC,SAAS,CAAC,MAAM,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,GAAE;YACtF,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,IAAI,SAAS;QAEb,IAAI,YAAY;YAChB,SAAS,MAAM,0HAAM,CAAC,MAAM,CAAC,UAAU,CAAC;gBAC5B,OAAO;oBAAC,MAAM;gBAAW;YAC7B;YACA,IAAI,CAAC,QAAO;gBAChB,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAmB,GAAG;oBAAE,QAAQ;gBAAI;YAC1E;QACA;QAEI,8CAA8C;QAClD,IAAG,cAAc,OAAO,UAAU,EAAC;YAC/B,MAAM,aAAa,MAAM,0HAAM,CAAC,KAAK,CAAC,QAAQ,CAAC;gBAAC,OAAO;oBAAC;gBAAM;YAAC;YAC/D,IAAG,WAAW,MAAM,GAAG,GAAE;gBACrB,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAA6B,GAAG;oBAAE,QAAQ;gBAAI;YACpF;QACJ;QAEA,MAAM,eAAe,IAAI;YAAC,MAAM;QAAM;QAEtC,4CAA4C;QAC5C,IAAI,cAAc,OAAO,SAAS,EAAC;YAC/B,IAAG,CAAC,cAAa;gBACb,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAgC,GAAG;oBAAE,QAAQ;gBAAI;YACvF;QACJ;QAEC,sCAAsC;QACtC,MAAM,gBAAgB,IAAI;QAE1B,KAAI,MAAM,QAAQ,MAAM;YACrB,MAAM,UAAU,MAAM,0HAAM,CAAC,OAAO,CAAC,UAAU,CAAC;gBAAC,OAAO;oBAAC,IAAI,KAAK,EAAE;gBAAA;YAAC;YACrE,MAAM,UAAU,QAAQ,OAAO;YAC/B,IAAG,CAAC,cAAc,GAAG,CAAC,UAAS;gBAC3B,cAAc,GAAG,CAAC,SAAS,EAAE;YACjC;YACA,cAAc,GAAG,CAAC,SAAS,IAAI,CAAC;gBAAC,GAAG,IAAI;gBAAE,OAAO,QAAQ,KAAK;YAAA;QACjE;QAEA,IAAI,WAAW,EAAE;QACjB,IAAI,aAAa;QAEjB,IAAI,qBAAqB;QAEzB,gCAAgC;QAChC,KAAI,MAAM,CAAC,SAAS,YAAY,IAAI,cAAc,OAAO,GAAG;YACzD,IAAI,QAAQ,YAAY,MAAM,CAAC,CAAC,KAAK,OAAO,MAAO,KAAK,KAAK,GAAG,KAAK,QAAQ,EAAG;YAEhF,IAAG,YAAW;gBACV,SAAS,AAAC,QAAQ,OAAO,QAAQ,GAAI;YACzC;YACA,IAAG,CAAC,gBAAgB,CAAC,oBAAmB;gBACpC,SAAS;gBACT,qBAAqB;YACzB;YAEA,cAAc,WAAW,MAAM,OAAO,CAAC;YAEvC,MAAM,QAAQ,MAAM,0HAAM,CAAC,KAAK,CAAC,MAAM,CAAC;gBACpC,MAAM;oBACF;oBACC;oBACA;oBACA,OAAO,WAAW,MAAM,OAAO,CAAC;oBAChC;oBACA,cAAc,SAAS,OAAO;oBAC9B,QAAQ,SAAS,SAAS,CAAC;oBAC1B,YAAY;wBACV,QAAQ,YAAY,GAAG,CAAC,CAAA,OAAQ,CAAC;gCAC7B,WAAW,KAAK,EAAE;gCAClB,UAAU,KAAK,QAAQ;gCACvB,OAAO,KAAK,KAAK;4BACrB,CAAC;oBACH;gBACN;YACJ;YACA,SAAS,IAAI,CAAC,MAAM,EAAE;QACzB;QAEA,IAAG,kBAAkB,UAAS;YAC3B,MAAM,SAAS,IAAA,mKAAM,EAAC,QAAQ,GAAG,CAAC,iBAAiB;YACnD,MAAM,SAAS,MAAM,QAAQ,OAAO,CAAC,GAAG,CAAC;YAEzC,MAAM,UAAU,MAAM,OAAO,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;gBAClD,sBAAsB;oBAAC;iBAAO;gBAC9B,YAAY;oBAAC;wBACT,YAAW;4BACP,UAAU;4BACV,cAAa;gCACT,MAAM;4BACV;4BACA,aAAa,KAAK,KAAK,CAAC,aAAa;wBACzC;wBACA,UAAU;oBACd;iBAAE;gBACF,YAAY,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK,QAAQ,KAAK;gBACjD,MAAM;gBACN,aAAa,GAAG,OAAO,uBAAuB,CAAC;gBAC/C,YAAY,GAAG,OAAO,KAAK,CAAC;gBAC5B,UAAU;oBACN,UAAU,SAAS,IAAI,CAAC;oBACxB;oBACA,OAAO;gBACX;YACJ;YACA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAC;YAAO;QACpC;QAEC,iBAAiB;QACjB,MAAM,0HAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACvB,OAAO;gBAAC,IAAI;YAAM;YAClB,MAAM;gBAAC,MAAO,CAAC;YAAC;QAClB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAC,SAAS;QAA4B;IAErE,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,IAAI,IAAI,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnF;AACJ;AAGO,eAAe,IAAI,OAAO;IAC7B,IAAI;QACA,MAAM,EAAE,MAAM,EAAE,GAAG,IAAA,wLAAO,EAAC;QAC3B,MAAM,SAAS,MAAM,0HAAM,CAAC,KAAK,CAAC,QAAQ,CAAC;YACvC,OAAO;gBAAC;gBAAQ,IAAI;oBAChB;wBAAC,eAAe,8IAAa,CAAC,GAAG;oBAAA;oBACjC;wBAAC,KAAK;4BAAC;gCAAC,eAAe,8IAAa,CAAC,MAAM;4BAAA;4BAAG;gCAAC,QAAQ;4BAAI;yBAAE;oBAAA;iBAChE;YAAA;YACD,SAAS;gBACL,YAAY;oBAAC,SAAS;wBAAC,SAAS;oBAAI;gBAAC;gBACrC,SAAS;YACb;YACA,SAAS;gBAAC,WAAW;YAAM;QAC/B;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAC;QAAM;IACpC,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE;AACJ","debugId":null}}]
}